# Checks

Explanations of all checks in `ezproxy-config-lint`.

<!-- ToC begin -->
  - [L1 - Ordering Issues](#l1---ordering-issues)
    - [L1001 - `Title` directive is out of order](#l1001---title-directive-is-out-of-order)
    - [L1002 - `URL` directive is out of order](#l1002---url-directive-is-out-of-order)
    - [L1003 - `AnonymousURL -*` directive is out of order](#l1003---anonymousurl---directive-is-out-of-order)
    - [L1004 - `AnonymousURL` directive is out of order](#l1004---anonymousurl-directive-is-out-of-order)
    - [L1005 - An Option 'opener' directive is out of order](#l1005---an-option-opener-directive-is-out-of-order)
    - [L1006 - An Option 'closer' directive is out of order](#l1006---an-option-closer-directive-is-out-of-order)
    - [L1008 - `ProxyHostnameEdit` directive is out of order](#l1008---proxyhostnameedit-directive-is-out-of-order)
    - [L1009 - `ProxyHostnameEdit` domains should be placed in deepest-to-shallowest order](#l1009---proxyhostnameedit-domains-should-be-placed-in-deepest-to-shallowest-order)
    - [L1010 - `URL` directive is before `Title` directive](#l1010---url-directive-is-before-title-directive)
    - [L1011 - `AddUserHeader` directive is out of order](#l1011---adduserheader-directive-is-out-of-order)
    - [L1012 - `AddUserHeader` directive is out of order](#l1012---adduserheader-directive-is-out-of-order)
  - [L2 - Duplication Issues](#l2---duplication-issues)
    - [L2001 - Duplicate `Title` directive in stanza](#l2001---duplicate-title-directive-in-stanza)
    - [L2002 - Origin already seen](#l2002---origin-already-seen)
    - [L2003 - Duplicate `URL` directive in stanza](#l2003---duplicate-url-directive-in-stanza)
    - [L2004 - `Title` value already seen](#l2004---title-value-already-seen)
  - [L3 - Malformation Issues](#l3---malformation-issues)
    - [L3001 - `ProxyHostnameEdit` directive must have both a find and replace qualifier](#l3001---proxyhostnameedit-directive-must-have-both-a-find-and-replace-qualifier)
    - [L3002 - Find part of `ProxyHostnameEdit` directive should end with a `$`](#l3002---find-part-of-proxyhostnameedit-directive-should-end-with-a-)
    - [L3003 - Replace part of `ProxyHostnameEdit` directive is malformed](#l3003---replace-part-of-proxyhostnameedit-directive-is-malformed)
    - [L3004 -  `Domain` and `DomainJavaScript` directives should only specify domains](#l3004----domain-and-domainjavascript-directives-should-only-specify-domains)
    - [L3005 - Unable to parse `URL`](#l3005---unable-to-parse-url)
    - [L3006 - `URL` does not start with `http` or `https`](#l3006---url-does-not-start-with-http-or-https)
    - [L3007 -  `URL` is not using HTTPS scheme](#l3007----url-is-not-using-https-scheme)
    - [L3008 - `Option` directive not in the form `Option OPTIONNAME`](#l3008---option-directive-not-in-the-form-option-optionname)
    - [L3009 - `URL` directive is not in the right format](#l3009---url-directive-is-not-in-the-right-format)
  - [L4 - Missing Directive Issues](#l4---missing-directive-issues)
    - [L4001 - Missing `AnonymousURL -*` at end of stanza](#l4001---missing-anonymousurl---at-end-of-stanza)
    - [L4002 - Missing Option at end of stanza](#l4002---missing-option-at-end-of-stanza)
    - [L4003 - Stanza has `Title` but no `URL`](#l4003---stanza-has-title-but-no-url)
    - [L4004 - `Find` directive must be immediately proceeded with a `Replace` directive](#l4004---find-directive-must-be-immediately-proceeded-with-a-replace-directive)
    - [L4005 - Missing `AddUserHeader` at end of stanza](#l4005---missing-adduserheader-at-end-of-stanza)
  - [L5 - Styling Issues](#l5---styling-issues)
    - [L5001 - Directive uses the wrong case.](#l5001---directive-uses-the-wrong-case)
    - [L5002 - Line ends in a space or tab character.](#l5002---line-ends-in-a-space-or-tab-character)
  - [L9 - Other Issues](#l9---other-issues)
    - [L9001 - Unknown directive](#l9001---unknown-directive)
    - [L9002 - Source title doesn't match](#l9002---source-title-doesnt-match)
    - [L9003 - Error processing Source line](#l9003---error-processing-source-line)
<!-- Generated by gh-toc, https://moonbase59.github.io/gh-toc/ -->
<!-- ToC end -->

## L1 - Ordering Issues

### L1001 - `Title` directive is out of order

The `Title` directive are only allowed to follow these directives:

* `Group`
* `HTTPMethod`
* `AddUserHeader`
* `AnonymousURL`
* `ProxyHostnameEdit`
* `Referer`
* `Cookie`
* `OptionEbraryUnencodedTokens`
* `Option DomainCookieOnly`
* `Option NoCookie`
* `Option CookiePassThrough`
* `Option HideEZproxy`
* `Option NoHttpsHyphens`
* `Option MetaEZproxyRewriting`
* `Option ProxyFTP`
* `Option UTF16`
* `Option X-Forwarded-For`

---------

### L1002 - `URL` directive is out of order

The `URL` directive are only allowed to follow these directives:

* `AllowVars`
* `EBLSecret`
* `EbrarySit`
* `EncryptVar`
* `HTTPHeader`
* `MimeFilter`
* `Title`

---------

### L1003 - `AnonymousURL -*` directive is out of order

The `AnonymousURL -*` directive is only allowed to follow these directives:

* `URL`
* `Host`
* `HostJavaScript`
* `Domain`
* `DomainJavaScript`
* `Replace`
* `AddUserHeader`
* `NeverProxy`
* `Option Cookie`
* `Option NoHideEZproxy`
* `Option HttpsHyphens`
* `Option NoMetaEZproxyRewriting`
* `Option NoProxyFTP`
* `Option NoUTF16`
* `Option NoXForwardedFor`

---------

### L1004 - `AnonymousURL` directive is out of order

Except for the ending `AnonymousURL -*` usage (see [L1003](#l1003---anonymousurl---directive-is-out-of-order)),
the `AnonymousURL` directive is only allowed to follow these directives:

* `Group`
* `HTTPMethod`
* `AddUserHeader`
* `AnonymousURL`
* `ProxyHostnameEdit`
* `Option DomainCookieOnly`
* `Option NoCookie`
* `Option CookiePassThrough`
* `Option HideEZproxy`
* `Option NoHttpsHyphens`
* `Option MetaEZproxyRewriting`
* `Option ProxyFTP`
* `Option UTF16`
* `Option X-Forwarded-For`

---------

### L1005 - An Option 'opener' directive is out of order

* `Option DomainCookieOnly`
* `Option NoCookie`
* `Option CookiePassThrough`
* `Option HideEZproxy`
* `Option NoHttpsHyphens`
* `Option MetaEZproxyRewriting`
* `Option ProxyFTP`
* `Option UTF16`
* `Option X-Forwarded-For`

directives are only allowed to follow other 'opener' directives and:

* `Group`
* `HTTPMethod`
* `AddUserHeader`
* `AnonymousURL`

'Opener' directives are Option directives which have a corresponding 'closer' Option directive. See [L4002](#l1004---anonymousurl-directive-is-out-of-order) for more information.

---------

### L1006 - An Option 'closer' directive is out of order

* `Option Cookie`
* `Option NoHideEZproxy`
* `Option HttpsHyphens`
* `Option NoMetaEZproxyRewriting`
* `Option NoProxyFTP`
* `Option NoUTF16`
* `Option NoX-Forwarded-For`

directives are only allowed to follow other 'closer' directives and:

* `URL`
* `Host`
* `HostJavaScript`
* `Domain`
* `DomainJavaScript`
* `Replace`
* `AddUserHeader`
* `AnonymousURL`
* `NeverProxy`

'Closer' directives are Option directives which have a corresponding 'opener' Option directive. See [L4002](#l1004---anonymousurl-directive-is-out-of-order)) for more information.

---------

### L1008 - `ProxyHostnameEdit` directive is out of order

The `ProxyHostnameEdit` directive is only allowed to follow the following directives:

* `Group`
* `HTTPMethod`
* `AddUserHeader`
* `AnonymousURL`
* `ProxyHostnameEdit`
* `Option DomainCookieOnly`
* `Option NoCookie`
* `Option CookiePassThrough`
* `Option HideEZproxy`
* `Option NoHttpsHyphens`
* `Option MetaEZproxyRewriting`
* `Option ProxyFTP`
* `Option UTF16`
* `Option X-Forwarded-For`

---------

### L1009 - `ProxyHostnameEdit` domains should be placed in deepest-to-shallowest order

This check is enabled with the `-phe=true` option.

It is best explained with an example.
Lets say you have these two lines in your stanza:

```
ProxyHostnameEdit heinonline.org$ heinonline-org
ProxyHostnameEdit home.heinonline.org$ home-heinonline-org
```

Assume EZproxy was processing the domain name `home.heinonline.org`.
It would start with the first line, and the resulting find and replace action would generate the domain name `home.heinonline-org`.
Because that domain name has one period and one hyphen, it would not match the second `ProxyHostnameEdit` line.
You always want to start with more specific, deeper subdomains.

We use "deeper" instead of "longer" here, because areallylongdomainhere.com is only two components deep,
but a.short.domain.ca is four components deep.

---------

### L1010 - `URL` directive is before `Title` directive

The `URL` directive should always come after the `Title` is a given stanza.

---------

### L1011 - `AddUserHeader` directive is out of order

The `AddUserHeader` directive with no qualifiers is only allowed to follow these directives:

* `URL`
* `Host`
* `HostJavaScript`
* `Domain`
* `DomainJavaScript`
* `Replace`
* `AnonymousURL`
* `NeverProxy`
* `ProxyHostnameEdit`
* `Option Cookie`
* `Option NoHideEZproxy`
* `Option HttpsHyphens`
* `Option NoMetaEZproxyRewriting`
* `Option NoProxyFTP`
* `Option NoUTF16`
* `Option NoXForwardedFor`

---------

### L1012 - `AddUserHeader` directive is out of order

Except for the ending `AddUserHeader` usage (see [L1011](#l1011---adduserheader-directive-is-out-of-order)),
the `AddUserHeader` directive is only allowed to follow these directives:

* `Group`
* `HTTPMethod`
* `AddUserHeader`
* `AnonymousURL`
* `ProxyHostnameEdit`
* `Option DomainCookieOnly`
* `Option NoCookie`
* `Option CookiePassThrough`
* `Option HideEZproxy`
* `Option NoHttpsHyphens`
* `Option MetaEZproxyRewriting`
* `Option ProxyFTP`
* `Option UTF16`
* `Option X-Forwarded-For`

## L2 - Duplication Issues

### L2001 - Duplicate `Title` directive in stanza

More than one `Title` directive present in a stanza.

---------

### L2002 - Origin already seen

EZproxy [only reads origins and does not read paths](https://help.oclc.org/Library_Management/EZproxy/Configure_resources/Groups).
The origin is the combination of the scheme (http or https), the host (google.com, help.oclc.org), and the port.
EZproxy does not care about paths (/astronomy, /login).
The linter will report if you've already used an origin, so that you can ensure that limiting access via Groups works as you expect.

---------

### L2003 - Duplicate `URL` directive in stanza

More than one `URL` directive present in a stanza.

---------

### L2004 - `Title` value already seen

The linter tracks stanza `Title` values and reports when a value has been seen more than
once.

## L3 - Malformation Issues

### L3001 - `ProxyHostnameEdit` directive must have both a find and replace qualifier

The `ProxyHostnameEdit` directive requires two qualifiers.
See [OCLC Documentation](https://help.oclc.org/Library_Management/EZproxy/Configure_resources/ProxyHostnameEdit) for more details.

---------

### L3002 - Find part of `ProxyHostnameEdit` directive should end with a `$`

This check is enabled with the `-phe=true` option.

The first qualifier to `ProxyHostnameEdit`, *find*, is a regular expression and should end in a dollar sign (`$`) to match the end of the string.

---------

### L3003 - Replace part of `ProxyHostnameEdit` directive is malformed

This check is enabled with the `-phe=true` option.

To make redirects from HTTP to HTTPS links more reliable, this check ensures that the *find* and *replace* qualifiers correspond with each other: *replace* should just be *find*, but with the trailing `$` removed and the periods replaced with hypens. For example, `home.heinonline.org$` corresponds with `home-heinonline-org`.

---------

### L3004 -  `Domain` and `DomainJavaScript` directives should only specify domains

The `Domain` and `DomainJavaScript` directives should only specify domains.
No URLs or path components should be used.

---------

### L3005 - Unable to parse `URL`

The URL part of this directive could not be parsed, check to see if it is malformed.

---------

### L3006 - `URL` does not start with `http` or `https`

The scheme/protocol of the URL should be specified, and it should either be `http` or `https`.

---------

### L3007 -  `URL` is not using HTTPS scheme

This check is enabled with the `-https=true` option.

The URL should use the `https` scheme/protocol.

---------

### L3008 - `Option` directive not in the form `Option OPTIONNAME`

The `Option` directive needs a second part. You can see the list of options in the [OCLC documentation](https://help.oclc.org/Library_Management/EZproxy/Configure_resources).

---------

### L3009 - `URL` directive is not in the right format

The `URL` directive must be in the [URL (version 1)](https://help.oclc.org/Library_Management/EZproxy/Configure_resources/URL_version_1), [URL (version 2)](https://help.oclc.org/Library_Management/EZproxy/Configure_resources/URL_version_2), or [URL (version 3)](https://help.oclc.org/Library_Management/EZproxy/Configure_resources/URL_version_3) format. Ensure line is not malformed.

## L4 - Missing Directive Issues

### L4001 - Missing `AnonymousURL -*` at end of stanza

Stanzas which use a AnonymousURL directive should include a `AnonymousURL -*` line at the end of the stanza so that other stanzas in the config file are not impacted.

---------

### L4002 - Missing Option at end of stanza

Stanzas which use options like `Option X-Forwarded-For` or `Option DomainCookieOnly` need to have a corresponding option like `Option NoX-Forwarded-For` or `Option Cookie` at the end of the stanza to ensure these options do not impact other stanzas.

Here's the table of 'opener' and 'closer' Option directives:

|Opener|Closer|
|---|---|
| Option DomainCookieOnly | Option Cookie |
| Option NoCookie | Option Cookie |
| Option CookiePassThrough | Option Cookie |
| Option HideEZproxy | Option NoHideEZproxy |
| Option NoHttpsHyphens | Option HttpsHyphens |
| Option MetaEZproxyRewriting | Option NoMetaEZproxyRewriting |
| Option ProxyFTP | Option NoProxyFTP |
| Option UTF16 | Option NoUTF16 |
| Option X-Forwarded-For | OptionNoXForwardedFor |

---------

### L4003 - Stanza has `Title` but no `URL`

Stanzas should have both a Title and a URL directive.

---------

### L4004 - `Find` directive must be immediately proceeded with a `Replace` directive

From the [OCLC documentation](https://help.oclc.org/Library_Management/EZproxy/Configure_resources/Find_Replace):

"These directives always appear paired together, with Find appearing directly before its corresponding Replace."

---------

### L4005 - Missing `AddUserHeader` at end of stanza

From the [OCLC documentation](https://help.oclc.org/Library_Management/EZproxy/Configure_resources/AddUserHeader):

"Omit both -base64 and headername to direct EZproxy to exclude this header for the databases that follow."

Stanzas which use a AddUserHeader directive should include a `AddUserHeader` directive with no other qualifiers at the end of the stanza so that other stanzas in the config file are not impacted.

## L5 - Styling Issues

### L5001 - Directive uses the wrong case.

This check is enabled with the `-case=true` option.

The directive was found, but it does not use the normal case. For example, TITLE instead of Title, or HTTPheader instead of HTTPHeader.

---------

### L5002 - Line ends in a space or tab character.

This check is enabled with the `-whitespace=true` option.

Trailing whitespace characters space or tab were found on this line.

## L9 - Other Issues

### L9001 - Unknown directive

An unknown directive was encountered. This can be caused by a typo in the directive. You can check the list of possible directives in the [OCLC documentation](https://help.oclc.org/Library_Management/EZproxy/Configure_resources).

---------

### L9002 - Source title doesn't match

This check is disabled with the `-source=false` option.

The linter has a built-in way to check the OCLC website for updates to some database stanzas.
If a comment is seen which matches the pattern `# Source - https://help.oclc.org/Library_Management/EZproxy/EZproxy_database_stanzas/...`,
the tool will check the stanza at the provided URL and pull out the `Title` directive.
The tool will report if the stanza title in the config file does not match the stanza title from the OCLC website.

For example, for the resource Docuseek2, if the stanza begins with a `Source` comment:

```
# Source - https://help.oclc.org/Library_Management/EZproxy/EZproxy_database_stanzas/Database_stanzas_D/Docuseek2
Title Docuseek2 (updated 20180101)
...
```
the linter will visit https://help.oclc.org/Library_Management/EZproxy/EZproxy_database_stanzas/Database_stanzas_D/Docuseek2,
and pull out the `Title` directive, which might be:

```
Title Docuseek2 (updated 20191015)
...
```

Because the `Title` directives do not match, the tool will report that you might want to update the stanza from the source.

---------

### L9003 - Error processing Source line

There was some problem processing the Source line. The URL might be malformed, or there was an HTTP request issue.
